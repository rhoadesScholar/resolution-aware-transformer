# Medical Segmentation Experiment Configuration - ISIC 2018
# Run with: python ray_train.py --config configs/medical_segmentation.yaml --num-gpus 4
# 
# ISIC 2018 Task 1 dataset with proper segmentation masks will be automatically downloaded.
# This dataset contains 2594 training and 1000 validation dermoscopic images with pixel-level lesion masks.
# 
# Published baselines for comparison (ISIC 2018 Task 1):
# - U-Net baseline: Dice = 0.849, IoU = 0.738 (Berseth, 2018)
# - DeepLabV3+: Dice = 0.857, IoU = 0.752 
# - Best method (nnU-Net style): Dice = 0.884, IoU = 0.791
# Reference: "The 2018 ISIC Challenge on Skin Lesion Analysis" (https://arxiv.org/abs/1902.03368)

# Experiment metadata
experiment_name: "rat_medical_segmentation_isic2018"
description: "Resolution Aware Transformer for ISIC 2018 skin lesion segmentation with proper ground truth masks"
task_type: "segmentation"

# Random seed for reproducibility
seed: 42

# Dataset configuration
data:
  dataset_name: "isic2018"
  dataset_url: "https://challenge.isic-archive.com/data/#2018"
  local_data_dir: "/tmp/datasets/isic2018"  # Will be automatically moved to /scratch/{username}/rat/datasets/
  image_size: 256
  # num_workers: 4
  train_split: "train"
  val_split: "val"
  
  # Download configuration
  download_timeout_factor: 3  # Multiply estimated time by this factor for timeout
  min_download_timeout: 30    # Minimum timeout in seconds
  max_download_timeout: 3600  # Maximum timeout in seconds (1 hour)
  
  # Data augmentation (similar to ISIC baselines)
  augmentation:
    random_flip: 0.5
    random_rotation: 15
    color_jitter: 0.1
    elastic_transform: 0.1   # Helps with skin lesion variations
    normalize:
      mean: [0.485, 0.456, 0.406]  # ImageNet normalization works well for dermoscopy
      std: [0.229, 0.224, 0.225]

# Model configuration
model:
  name: "rat"
  spatial_dims: 2
  input_features: 3
  feature_dims: 128
  num_blocks: 4
  num_heads: 8
  attention_type: "dense"
  multi_scale: false  # Set to true for multi-scale experiments
  learnable_rose: true
  mlp_ratio: 4
  mlp_dropout: 0.1
  
  # Segmentation-specific parameters
  num_classes: 1  # Binary segmentation (lesion vs background)

# Training configuration
training:
  epochs: 100
  # Batch size will be automatically optimized based on GPU memory
  # Set target_effective_batch_size to match baseline papers
  target_effective_batch_size: 32  # ISIC 2018 U-Net baseline effective batch size
  learning_rate: 1e-4
  weight_decay: 0.01
  scheduler: "cosine"
  warmup_epochs: 5  # Gradual warmup helps with training stability
  loss: "combined"  # BCE + Dice loss for segmentation (standard for ISIC)
  dice_weight: 0.5  # Balance between Dice and BCE loss
  bce_weight: 0.5
  grad_clip: 1.0
  mixed_precision: true
  use_deepspeed: true  # Enable DeepSpeed Stage 2/3 for memory optimization
  
  # Automatic optimization features
  auto_batch_size: true  # Calculate optimal batch size based on GPU memory
  gradient_accumulation: "auto"  # Automatically set to achieve target_effective_batch_size

# Results and logging (saved to network drive with repo)
results:
  output_dir: "./results/medical_segmentation"  # Network drive path
  save_checkpoints: true
  checkpoint_freq: 10
  log_freq: 100

# Evaluation metrics (standard for ISIC 2018)
evaluation:
  metrics: ["dice", "iou", "sensitivity", "specificity", "accuracy"]
  eval_freq: 5
  
  # Target metrics based on published baselines
  target_dice: 0.849    # U-Net baseline to beat
  target_iou: 0.738     # Corresponding IoU score