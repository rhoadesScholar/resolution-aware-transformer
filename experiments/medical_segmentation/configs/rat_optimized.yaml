# RAT Optimized Configuration for ISIC 2018 Segmentation

# Experiment metadata
experiment_name: "rat_optimized_isic2018"
description: "Memory-optimized Resolution Aware Transformer for skin lesion segmentation matching baseline model size (~19M params)"

# Random seed for reproducibility
seed: 42

# Data configuration
data:
  data_dir: "/path/to/ISIC2018"  # Update this path
  image_size: 256  # Standard resolution for fair comparison with baselines
  num_workers: 12

# Model configuration - Optimized for ~19M parameters (matching baseline)
model:
  name: "rat"
  multi_scale: true
  scales: [256, 128]  # Dual scale for memory efficiency
  spatial_dims: 2
  input_features: 3
  feature_dims: 256    # Standard feature dimensions
  num_blocks: 4        # Standard number of blocks
  num_heads: 16        # Standard number of heads
  attention_type: ["sparse", "sparse", "dense", "dense"]  # Sparse early, dense later

  # Positional encoding
  positional_encoding: "rose"  # Resolution-aware spatial embeddings
  learnable_rose: true
  
  # MLP optimization
  mlp_ratio: 4      # Standard MLP ratio
  mlp_dropout: 0.1

training:
  num_epochs: 100
  
  optimizer:
    name: "adamw"
    lr: 1e-4      # Standard learning rate for this model size
    weight_decay: 0.01
    betas: [0.9, 0.999]
  
  scheduler:
    name: "cosine"
    min_lr: 1e-6
  
  # Training optimization
  mixed_precision: true
  gradient_clip: 1.0
  
  # Batch size optimized for H100 80GB GPUs with DeepSpeed Stage 2
  batch_size: 16   # Per-GPU batch size - matches original baseline (16)
  # Alternative: Could use 32-48 for maximum H100 utilization, but 16 matches baseline training

eval:
  eval_interval: 5
  save_interval: 10

logging:
  experiment_name: "rat_optimized_deepspeed"
  save_dir: "./checkpoints"
  log_dir: "./results/tensorboard_logs"  # Proper TensorBoard logging directory
  log_interval: 50

# DeepSpeed Stage 2 optimization (not Stage 3)
deepspeed:
  # Use Stage 2 for good performance/memory balance
  zero_stage: 2
  
  # No CPU offloading for Stage 2 (better performance)
  cpu_offload: false
  
  # Moderate activation checkpointing
  activation_checkpointing: true
  
  # Optimized bucket sizes for Stage 2
  stage2_reduce_bucket_size: 5e8
  stage2_allgather_bucket_size: 5e8